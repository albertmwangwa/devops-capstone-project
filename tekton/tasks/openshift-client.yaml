# tekton/tasks/openshift-client.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: openshift-client
spec:
  workspaces:
    - name: source
  params:
    - name: namespace
      type: string
      default: "default"
    - name: image-name
      type: string
    - name: image-tag
      type: string
      default: "latest"
  steps:
    - name: deploy
      image: quay.io/openshift/origin-cli:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        echo "=== OpenShift Deployment ==="
        
        # AUTO-LOGIN USING SERVICE ACCOUNT TOKEN
        # Token is automatically mounted here:
        TOKEN_FILE="/var/run/secrets/kubernetes.io/serviceaccount/token"
        CA_FILE="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        
        if [ ! -f "$TOKEN_FILE" ]; then
          echo "ERROR: Service account token not found!"
          echo "Make sure PipelineRun has: serviceAccountName: pipeline"
          exit 1
        fi
        
        echo "Logging in with service account..."
        TOKEN=$(cat $TOKEN_FILE)
        oc login https://kubernetes.default.svc \
          --token="$TOKEN" \
          --certificate-authority="$CA_FILE" \
          --insecure-skip-tls-verify=true
        
        echo "✅ Logged in as: $(oc whoami)"
        
        # Set namespace
        TARGET_NS=$(params.namespace)
        oc project $TARGET_NS 2>/dev/null || oc new-project $TARGET_NS
        
        # Simple deployment
        echo "Deploying $(params.image-name):$(params.image-tag)..."
        
        cat > /tmp/app.yaml <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: accounts
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: accounts
          template:
            metadata:
              labels:
                app: accounts
            spec:
              containers:
              - name: accounts
                image: $(params.image-name):$(params.image-tag)
                ports:
                - containerPort: 8080
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: accounts
        spec:
          selector:
            app: accounts
          ports:
          - port: 8080
            targetPort: 8080
        EOF
        
        oc apply -f /tmp/app.yaml
        echo "✅ Deployment completed!"
        
        # Show status
        oc get deployment,svc accounts